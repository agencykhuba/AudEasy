{% extends "base.html" %}
{% block title %}Create CAR - Enhanced{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <h1 class="text-3xl font-bold mb-6">Create Corrective Action Request</h1>

    <form id="carForm" data-progressive-form method="POST" action="/cars/create">
        
        <!-- Section 1: Basic Information -->
        <div data-section="1" class="mb-6 bg-gray-800 rounded-lg p-6">
            <div data-section-header class="flex items-center mb-4">
                <span class="section-arrow mr-2">▼</span>
                <h2 class="text-xl font-semibold">1. Basic Information</h2>
                <button type="button" data-tooltip="car_description" class="ml-2 text-blue-400 hover:text-blue-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
            </div>
            
            <div data-section-content>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">
                        What happened? <span class="text-red-400">*</span>
                    </label>
                    <textarea 
                        id="carDescription" 
                        name="description" 
                        rows="4" 
                        required
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-400"
                        placeholder="Describe the issue in your own words..."
                    ></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Location</label>
                        <input type="text" id="location" name="location" 
                            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">When?</label>
                        <input type="text" id="when" name="when" 
                            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Severity & Category -->
        <div data-section="2" class="mb-6 bg-gray-800 rounded-lg p-6">
            <div data-section-header class="flex items-center mb-4">
                <span class="section-arrow mr-2">▶</span>
                <h2 class="text-xl font-semibold">2. Severity & Category</h2>
                <button type="button" data-tooltip="severity" class="ml-2 text-blue-400 hover:text-blue-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
            </div>
            
            <div data-section-content class="hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Category</label>
                        <select name="category" id="category" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                            <option value="">Select...</option>
                            <option value="Temperature Control">Temperature Control</option>
                            <option value="Pest Control">Pest Control</option>
                            <option value="Personal Hygiene">Personal Hygiene</option>
                            <option value="Cross Contamination">Cross Contamination</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Severity <span class="text-red-400">*</span></label>
                        <select name="severity" id="severity" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                            <option value="">Select...</option>
                            <option value="critical">Critical</option>
                            <option value="major">Major</option>
                            <option value="minor">Minor</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Root Cause -->
        <div data-section="3" class="mb-6 bg-gray-800 rounded-lg p-6">
            <div data-section-header class="flex items-center mb-4">
                <span class="section-arrow mr-2">▶</span>
                <h2 class="text-xl font-semibold">3. Root Cause</h2>
                <button type="button" data-tooltip="root_cause" class="ml-2 text-blue-400 hover:text-blue-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
            </div>
            
            <div data-section-content class="hidden">
                <textarea name="root_cause" rows="3" 
                    class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg" 
                    placeholder="Use the 5 Whys method..."></textarea>
            </div>
        </div>

        <!-- Section 4: Corrective Actions -->
        <div data-section="4" class="mb-6 bg-gray-800 rounded-lg p-6">
            <div data-section-header class="flex items-center mb-4">
                <span class="section-arrow mr-2">▶</span>
                <h2 class="text-xl font-semibold">4. Actions</h2>
            </div>
            
            <div data-section-content class="hidden">
                <div class="mb-4">
                    <textarea name="corrective_action" rows="3" 
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg" 
                        placeholder="What will be done?"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Responsible Person</label>
                        <input type="text" id="responsible_person" name="responsible_person" 
                            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Due Date</label>
                        <input type="date" id="due_date" name="due_date" 
                            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-end gap-3 mt-8">
            <a href="/dashboard" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">Cancel</a>
            <button type="submit" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg">Create CAR</button>
        </div>
    </form>
</div>

<script>
// Load smart defaults
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/cars/api/smart-defaults', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({form_type: 'car_creation', context: {}})
        });
        
        const data = await response.json();
        if (data.success && data.defaults) {
            Object.keys(data.defaults).forEach(field => {
                const input = document.getElementById(field);
                if (input && !input.value) {
                    input.value = data.defaults[field];
                }
            });
        }
    } catch (error) {
        console.error('Failed to load defaults:', error);
    }
});
</script>
{% endblock %}
