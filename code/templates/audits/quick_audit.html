{% extends "base.html" %}
{% block title %}Quick Audit - Daily Check{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-6">
    <!-- Header with Timer -->
    <div class="bg-blue-900 rounded-lg p-6 mb-6 text-center">
        <h1 class="text-2xl font-bold mb-2">Pre-Shift Quick Audit</h1>
        <p class="text-blue-200 mb-4">10 Critical Checks - Must PASS to operate</p>
        
        <div class="flex justify-center items-center gap-4">
            <div class="text-center">
                <div class="text-3xl font-bold" id="timer">5:00</div>
                <div class="text-sm text-blue-300">Target Time</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-green-400" id="progress">0/10</div>
                <div class="text-sm text-blue-300">Completed</div>
            </div>
        </div>
    </div>

    <form id="quickAuditForm" method="POST" action="{{ url_for('quick_audit.quick_audit') }}" class="space-y-6">
        
        <!-- Temperature Control Section -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4 text-blue-400">ï¿½ï¿½ï¸ Temperature Control</h2>
            
            <div class="space-y-4">
                <div class="audit-check">
                    <label class="block font-medium mb-2">Walk-in Cooler Temperature</label>
                    <div class="flex items-center gap-4">
                        <input type="number" 
                               name="temperature_control_walk_in_cooler" 
                               step="0.1"
                               class="flex-1 px-4 py-3 bg-gray-700 rounded-lg text-xl"
                               placeholder="Enter temp">
                        <span class="text-gray-400">Â°C (max 4Â°C)</span>
                    </div>
                </div>

                <div class="audit-check">
                    <label class="block font-medium mb-2">Freezer Temperature</label>
                    <div class="flex items-center gap-4">
                        <input type="number" 
                               name="temperature_control_freezer" 
                               step="0.1"
                               class="flex-1 px-4 py-3 bg-gray-700 rounded-lg text-xl"
                               placeholder="Enter temp">
                        <span class="text-gray-400">Â°C (max -18Â°C)</span>
                    </div>
                </div>

                <div class="audit-check">
                    <label class="block font-medium mb-2">Hot Hold Temperature</label>
                    <div class="flex items-center gap-4">
                        <input type="number" 
                               name="temperature_control_hot_hold" 
                               step="0.1"
                               class="flex-1 px-4 py-3 bg-gray-700 rounded-lg text-xl"
                               placeholder="Enter temp">
                        <span class="text-gray-400">Â°C (min 60Â°C)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Food Safety Section -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4 text-green-400">í½½ï¸ Food Safety</h2>
            
            <div class="space-y-4">
                <div class="audit-check">
                    <label class="block font-medium mb-2">Hand Wash Stations</label>
                    <div class="flex gap-4">
                        <button type="button" class="btn-choice flex-1 py-3" data-value="functional" data-name="food_safety_hand_wash_stations">
                            â Functional
                        </button>
                        <button type="button" class="btn-choice flex-1 py-3" data-value="not_functional" data-name="food_safety_hand_wash_stations">
                            â Issues
                        </button>
                    </div>
                </div>

                <div class="audit-check">
                    <label class="block font-medium mb-2">Cross-Contamination Control</label>
                    <div class="flex gap-4">
                        <button type="button" class="btn-choice flex-1 py-3" data-value="compliant" data-name="food_safety_cross_contamination_control">
                            â Compliant
                        </button>
                        <button type="button" class="btn-choice flex-1 py-3" data-value="not_compliant" data-name="food_safety_cross_contamination_control">
                            â Issues
                        </button>
                    </div>
                </div>

                <div class="audit-check">
                    <label class="block font-medium mb-2">Allergen Separation</label>
                    <div class="flex gap-4">
                        <button type="button" class="btn-choice flex-1 py-3" data-value="proper" data-name="food_safety_allergen_separation">
                            â Proper
                        </button>
                        <button type="button" class="btn-choice flex-1 py-3" data-value="improper" data-name="food_safety_allergen_separation">
                            â Issues
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sanitation Section -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4 text-purple-400">í·¼ Sanitation</h2>
            
            <div class="space-y-4">
                <div class="audit-check">
                    <label class="block font-medium mb-2">Sanitizer Concentration</label>
                    <div class="flex items-center gap-4">
                        <input type="number" 
                               name="sanitation_sanitizer_concentration" 
                               class="flex-1 px-4 py-3 bg-gray-700 rounded-lg text-xl"
                               placeholder="PPM">
                        <span class="text-gray-400">ppm (200-400)</span>
                    </div>
                </div>

                <div class="audit-check">
                    <label class="block font-medium mb-2">Equipment Cleanliness</label>
                    <div class="flex gap-4">
                        <button type="button" class="btn-choice flex-1 py-3" data-value="clean" data-name="sanitation_equipment_cleanliness">
                            â Clean
                        </button>
                        <button type="button" class="btn-choice flex-1 py-3" data-value="dirty" data-name="sanitation_equipment_cleanliness">
                            â Dirty
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personnel Section -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4 text-orange-400">í±¥ Personnel</h2>
            
            <div class="space-y-4">
                <div class="audit-check">
                    <label class="block font-medium mb-2">Sick Employee Policy</label>
                    <div class="flex gap-4">
                        <button type="button" class="btn-choice flex-1 py-3" data-value="compliant" data-name="personnel_sick_employee_policy">
                            â Compliant
                        </button>
                        <button type="button" class="btn-choice flex-1 py-3" data-value="violation" data-name="personnel_sick_employee_policy">
                            â Violation
                        </button>
                    </div>
                </div>

                <div class="audit-check">
                    <label class="block font-medium mb-2">Proper Uniforms</label>
                    <div class="flex gap-4">
                        <button type="button" class="btn-choice flex-1 py-3" data-value="yes" data-name="personnel_proper_uniforms">
                            â Yes
                        </button>
                        <button type="button" class="btn-choice flex-1 py-3" data-value="no" data-name="personnel_proper_uniforms">
                            â No
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="sticky bottom-4">
            <button type="submit" 
                    id="submitBtn"
                    class="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                Submit Quick Audit
            </button>
        </div>
    </form>
</div>

<style>
.btn-choice {
    background: #374151;
    border: 2px solid #4B5563;
    border-radius: 8px;
    transition: all 0.2s;
}

.btn-choice.selected {
    background: #3B82F6;
    border-color: #60A5FA;
    transform: scale(1.05);
}

.audit-check {
    padding: 1rem;
    background: #1F2937;
    border-radius: 8px;
}
</style>

<script>
// Timer logic
let startTime = Date.now();
let timerInterval = setInterval(() => {
    let elapsed = Math.floor((Date.now() - startTime) / 1000);
    let remaining = Math.max(0, 300 - elapsed); // 5 minutes
    let mins = Math.floor(remaining / 60);
    let secs = remaining % 60;
    document.getElementById('timer').textContent = 
        `${mins}:${secs.toString().padStart(2, '0')}`;
}, 1000);

// Choice button logic
document.querySelectorAll('.btn-choice').forEach(btn => {
    btn.addEventListener('click', function() {
        const name = this.dataset.name;
        const value = this.dataset.value;
        
        // Deselect siblings
        document.querySelectorAll(`[data-name="${name}"]`).forEach(b => {
            b.classList.remove('selected');
        });
        
        // Select this button
        this.classList.add('selected');
        
        // Create hidden input
        let input = document.querySelector(`input[name="${name}"]`);
        if (!input) {
            input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            document.getElementById('quickAuditForm').appendChild(input);
        }
        input.value = value;
        
        // Update progress
        updateProgress();
    });
});

// Progress tracking
function updateProgress() {
    const total = 10;
    const completed = document.querySelectorAll('.btn-choice.selected, input[type="number"][value!=""]').length;
    document.getElementById('progress').textContent = `${completed}/${total}`;
    
    // Enable submit when all complete
    document.getElementById('submitBtn').disabled = completed < total;
}

// Track number inputs
document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('input', updateProgress);
});

// Form submission
document.getElementById('quickAuditForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    const response = await fetch("{{ url_for('quick_audit.quick_audit') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.status === 'approved') {
        alert('â APPROVED FOR OPERATIONS\n\nAll critical checks passed!');
        window.location.href = '/dashboard';
    } else {
        alert(`â OPERATIONS BLOCKED\n\n${result.message}\n\nCAR #${result.car_id} created automatically.`);
        window.location.href = `/car/${result.car_id}`;
    }
});
</script>
{% endblock %}
